<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15åˆ†å—è®°å½•å™¨</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --border: #e2e8f0; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; max-width: 600px; margin: 0 auto; }
        
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        h2 { margin: 0 0 15px 0; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
        
        /* è¾“å…¥åŒºåŸŸæ ·å¼ */
        .form-row { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 5px; }
        
        input[type="text"], input[type="time"] {
            width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; outline: none; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); }

        /* 15åˆ†é’Ÿå—é€‰æ‹©å™¨ */
        .duration-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .dur-btn {
            background: #eff6ff; border: 1px solid transparent; color: var(--primary); padding: 10px 0; border-radius: 8px; font-weight: 600; cursor: pointer; text-align: center; font-size: 0.9rem; transition: 0.2s;
        }
        .dur-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .dur-btn:hover { opacity: 0.9; }

        /* æ“ä½œæŒ‰é’® */
        .btn-add { background: #10b981; color: white; border: none; width: 100%; padding: 14px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-export { background: white; border: 1px solid var(--border); color: #64748b; width: 100%; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; cursor: pointer; }

        /* æ—¶é—´è½´åˆ—è¡¨ */
        .timeline { position: relative; padding-left: 20px; margin-top: 10px; }
        .timeline::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: #e2e8f0; }
        
        .timeline-item { position: relative; margin-bottom: 20px; padding-left: 15px; }
        .timeline-item::after { 
            content: ''; position: absolute; left: -24px; top: 6px; width: 10px; height: 10px; 
            border-radius: 50%; background: white; border: 2px solid var(--primary); z-index: 2;
        }
        
        .time-badge { font-family: monospace; font-size: 0.85rem; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 4px; }
        .task-content { font-weight: 500; font-size: 1.05rem; display: flex; justify-content: space-between; align-items: flex-start; }
        .task-duration { font-size: 0.8rem; color: #f59e0b; background: #fffbeb; padding: 2px 6px; border-radius: 4px; margin-left: 8px; white-space: nowrap; }
        .delete-btn { color: #cbd5e1; margin-left: 10px; cursor: pointer; font-size: 1.2rem; line-height: 1; }
        .delete-btn:hover { color: #ef4444; }

        /* ç»Ÿè®¡æ¡ */
        .stats { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .stat-pill { background: #f8fafc; border: 1px solid var(--border); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; white-space: nowrap; color: #64748b; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ§± æ·»åŠ æ—¶é—´å—</h2>
        
        <div class="form-row">
            <label>å¼€å§‹æ—¶é—´</label>
            <input type="time" id="startTimeInput" required>
        </div>

        <div class="form-row">
            <input type="text" id="taskInput" placeholder="åšäº†ä»€ä¹ˆï¼Ÿ(å¦‚: é˜…è¯», ä¼šè®®)" autocomplete="off">
        </div>

        <div class="form-row">
            <label id="durationLabel">æŒç»­æ—¶é•¿: 15åˆ†é’Ÿ</label>
            <div class="duration-selector" id="durBtnGroup">
                <button class="dur-btn active" onclick="setDuration(15, this)">15m</button>
                <button class="dur-btn" onclick="setDuration(30, this)">30m</button>
                <button class="dur-btn" onclick="setDuration(45, this)">45m</button>
                <button class="dur-btn" onclick="setDuration(60, this)">1h</button>
                <button class="dur-btn" onclick="setDuration(90, this)">1.5h</button>
                <button class="dur-btn" onclick="setDuration(120, this)">2h</button>
                <button class="dur-btn" onclick="setDuration(180, this)">3h</button>
                <button class="dur-btn" onclick="setDuration(240, this)">4h</button>
            </div>
        </div>

        <button class="btn-add" onclick="addRecord()">å¡«å…¥æ—¶é—´è½´</button>
    </div>

    <div class="card">
        <h2>
            ğŸ“… ä»Šæ—¥è®°å½• 
            <span style="font-size:0.8rem; color:#94a3b8; font-weight:normal; cursor:pointer" onclick="clearData()">æ¸…ç©º</span>
        </h2>
        
        <div class="stats" id="statsBar"></div>

        <div class="timeline" id="timelineList">
            </div>
        
        <button class="btn-export" onclick="exportCSV()">ğŸ“¥ å¯¼å‡º CSV</button>
    </div>

    <script>
        let currentDuration = 15; // é»˜è®¤æ—¶é•¿(åˆ†é’Ÿ)
        let records = JSON.parse(localStorage.getItem('blockTimeLogs')) || [];

        window.onload = function() {
            initTimeInput();
            renderTimeline();
        }

        // --- äº¤äº’é€»è¾‘ ---

        function initTimeInput() {
            // å¦‚æœæœ‰è®°å½•ï¼Œé»˜è®¤å¼€å§‹æ—¶é—´ = ä¸Šä¸€æ¡çš„ç»“æŸæ—¶é—´
            // å¦‚æœæ²¡æœ‰ï¼Œé»˜è®¤å½“å‰æ—¶é—´
            const now = new Date();
            let defaultTime = now;

            if (records.length > 0) {
                // æ‰¾åˆ°æœ€åä¸€æ¡è®°å½•çš„ç»“æŸæ—¶é—´
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å¤„ç†æ—¥æœŸï¼Œç®€å•èµ·è§å‡è®¾æ˜¯å½“å¤©çš„è¿ç»­æ“ä½œ
                // å®é™…é€»è¾‘ï¼šå– records ä¸­ endTime æœ€å¤§çš„é‚£ä¸ª
                const lastRecord = records[0]; // recordsæ˜¯æŒ‰æ—¶é—´å€’åºå­˜çš„ï¼Œæ‰€ä»¥å–ç¬¬ä¸€ä¸ª
                // è§£æ "HH:MM"
                if (lastRecord) {
                    const [h, m] = lastRecord.endTime.split(':').map(Number);
                    defaultTime = new Date();
                    defaultTime.setHours(h, m, 0, 0);
                }
            }

            const h = defaultTime.getHours().toString().padStart(2, '0');
            const m = defaultTime.getMinutes().toString().padStart(2, '0');
            document.getElementById('startTimeInput').value = `${h}:${m}`;
        }

        function setDuration(mins, btn) {
            currentDuration = mins;
            // UI æ›´æ–°
            document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // æ–‡æœ¬æç¤º
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            let text = `${mins}åˆ†é’Ÿ`;
            if (h > 0 && m > 0) text = `${h}å°æ—¶ ${m}åˆ†é’Ÿ`;
            else if (h > 0) text = `${h}å°æ—¶`;
            document.getElementById('durationLabel').innerText = `æŒç»­æ—¶é•¿: ${text}`;
        }

        function addRecord() {
            const taskName = document.getElementById('taskInput').value.trim();
            const startTimeStr = document.getElementById('startTimeInput').value;
            
            if (!taskName) return alert('è¯·å¡«å†™å†…å®¹');
            if (!startTimeStr) return alert('è¯·é€‰æ‹©å¼€å§‹æ—¶é—´');

            // è®¡ç®—ç»“æŸæ—¶é—´
            const [startH, startM] = startTimeStr.split(':').map(Number);
            const startDate = new Date();
            startDate.setHours(startH, startM, 0, 0);
            
            const endDate = new Date(startDate.getTime() + currentDuration * 60000);
            const endH = endDate.getHours().toString().padStart(2, '0');
            const endM = endDate.getMinutes().toString().padStart(2, '0');
            const endTimeStr = `${endH}:${endM}`;

            const record = {
                id: Date.now(),
                task: taskName,
                startTime: startTimeStr,
                endTime: endTimeStr,
                duration: currentDuration,
                date: new Date().toLocaleDateString() // ç®€å•è®°å½•æ—¥æœŸ
            };

            records.push(record);
            // æŒ‰å¼€å§‹æ—¶é—´æ’åºï¼ˆå¤„ç†è¡¥å½•æƒ…å†µï¼‰
            records.sort((a, b) => {
                return a.startTime.localeCompare(b.startTime);
            });
            
            saveAndRender();
            
            // é‡ç½®è¾“å…¥æ¡†ï¼šå°†æ—¶é—´è‡ªåŠ¨æ¨åˆ°åˆšæ‰çš„ç»“æŸæ—¶é—´ï¼Œæ–¹ä¾¿è¿ç»­å½•å…¥
            document.getElementById('startTimeInput').value = endTimeStr;
            document.getElementById('taskInput').value = '';
            document.getElementById('taskInput').focus();
        }

        function deleteRecord(id) {
            if(confirm('åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) {
                records = records.filter(r => r.id !== id);
                saveAndRender();
            }
        }

        function clearData() {
            if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                records = [];
                saveAndRender();
                initTimeInput(); // é‡ç½®æ—¶é—´
            }
        }

        function saveAndRender() {
            localStorage.setItem('blockTimeLogs', JSON.stringify(records));
            renderTimeline();
        }

        // --- æ¸²æŸ“é€»è¾‘ ---

        function renderTimeline() {
            const list = document.getElementById('timelineList');
            const statsBar = document.getElementById('statsBar');
            list.innerHTML = '';
            
            // 1. æ¸²æŸ“åˆ—è¡¨ (å€’åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼Œæ–¹ä¾¿çœ‹)
            // å¦‚æœå–œæ¬¢æ—¶é—´è½´ä»æ—©åˆ°æ™šï¼Œå¯ä»¥å»æ‰ .reverse()
            const displayRecords = [...records].reverse(); 

            displayRecords.forEach(item => {
                const div = document.createElement('div');
                div.className = 'timeline-item';
                
                // è®¡ç®—å°æ—¶æ˜¾ç¤º
                const h = Math.floor(item.duration / 60);
                const m = item.duration % 60;
                let durText = `${m}m`;
                if (h > 0) durText = `${h}h${m > 0 ? m+'m' : ''}`;

                div.innerHTML = `
                    <div class="time-badge">${item.startTime} - ${item.endTime}</div>
                    <div class="task-content">
                        <span>${item.task}</span>
                        <div style="display:flex; align-items:center">
                            <span class="task-duration">â³ ${durText}</span>
                            <span class="delete-btn" onclick="deleteRecord(${item.id})">Ã—</span>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });

            // 2. æ¸²æŸ“ç®€å•ç»Ÿè®¡
            // æŒ‰ä»»åŠ¡åèšåˆæ—¶é•¿
            const stats = {};
            records.forEach(r => {
                stats[r.task] = (stats[r.task] || 0) + r.duration;
            });
            
            let statsHtml = '';
            for (let [task, mins] of Object.entries(stats)) {
                const h = (mins / 60).toFixed(1);
                statsHtml += `<div class="stat-pill">${task}: ${h}h</div>`;
            }
            statsBar.innerHTML = statsHtml || '<div class="stat-pill">æš‚æ— æ•°æ®</div>';
        }

        // --- å¯¼å‡º CSV ---
        function exportCSV() {
            if (records.length === 0) return alert("æ²¡æ•°æ®");
            
            let csv = "Date,Start,End,Task,Duration_Mins\n";
            records.forEach(r => {
                csv += `${r.date},${r.startTime},${r.endTime},${r.task},${r.duration}\n`;
            });

            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `time_blocks_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>
</body>
</html>
